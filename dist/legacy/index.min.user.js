// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     semi-automated editing with style
// @grant           none
// @homepage        https://github.com/userscripters/editors-den#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            editors-den
// @namespace       userscripters
// @source          git+https://github.com/userscripters/editors-den.git
// @supportURL      https://github.com/userscripters/editors-den/issues
// @version         1.0.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,o,u,c){return new(u=u||Promise)(function(t,r){function n(e){try{i(c.next(e))}catch(e){r(e)}}function a(e){try{i(c.throw(e))}catch(e){r(e)}}function i(e){var r;e.done?t(e.value):((r=e.value)instanceof u?r:new u(function(e){e(r)})).then(n,a)}i((c=c.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(t,n){var a,i,o,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:r(0),throw:r(1),return:r(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,(r=o?[2&r[0],o.value]:r)[0]){case 0:case 1:o=r;break;case 4:return u.label++,{value:r[1],done:!1};case 5:u.label++,i=r[1],r=[0];continue;case 7:r=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===r[0]||2===r[0])){u=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){u.label=r[1];break}if(6===r[0]&&u.label<o[1]){u.label=o[1],o=r;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(r);break}o[2]&&u.ops.pop(),u.trys.pop();continue}r=n.call(t,u)}catch(e){r=[6,e],i=0}finally{a=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}},__read=this&&this.__read||function(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,a,i=t.call(e),o=[];try{for(;(void 0===r||0<r--)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(a)throw a.error}}return o},__spreadArray=this&&this.__spreadArray||function(e,r){for(var t=0,n=r.length,a=e.length;t<n;t++,a++)e[a]=r[t];return e};__awaiter(void 0,void 0,void 0,function(){var r,i,t,n,a,o,u,c,l,s,f,h,d,p,_,v;return __generator(this,function(e){switch(e.label){case 0:return(r=function(e,r){return e.reduce(function(t,n){return __awaiter(void 0,void 0,void 0,function(){var r;return __generator(this,function(e){switch(e.label){case 0:return r=n,[4,t];case 1:return[4,r.apply(void 0,[e.sent()])];case 2:return[2,e.sent()]}})})},Promise.resolve(r))},i=function(t,n){return void 0===n&&(n=2.3),__awaiter(void 0,void 0,void 0,function(){var r;return __generator(this,function(e){switch(e.label){case 0:return(r=new URL("https://api.stackexchange.com/"+n+"/tags")).search=new URLSearchParams({site:location.hostname,inname:t.toLowerCase(),key:"C0zI0cCMTw5GRQIqHhvTHw(("}).toString(),[4,fetch(r.toString())];case 1:return(r=e.sent()).ok?[4,r.json()]:[2,[]];case 2:return[2,e.sent().items]}})})},t=function(e){var n=__spreadArray([],__read(e.matchAll(/\[\d+\]: \w+/gim))).length,r=__spreadArray([],__read(e.matchAll(/\[([\w\s:'#-?]+)\]\(([\w:/.#-]+)\)/gim)));return e+"\n\n"+r.reduce(function(e,r,t){r=__read(r,3),r[0],r[1],r=r[2];return e+"["+(n+t+1)+"]: "+r+"\n"},"")},n=function(e){return["I","Gmail","Firefox","JavaScript","HTML","jQuery","URL","SDK","Safari","Linux","Greasemonkey","API"].reduce(function(e,r){return e.replace(new RegExp("(\\s+|^)"+r+"(\\s+|$)","gmi"),"$1"+r+"$2")},e)},a=function(e){return e.replace(/\*{2}(\[.+?\]\(.+?\))\*{2}/gim,"$1")},o=function(e){return e.replace(/([?!,.])(\s+\(.+?\))/gm,"$2$1")},u=function(e){return e.replace(/^Hi\b/i,"")},c=function(e){return e.replace(/(?:^\n$)+/gim,"")},l=function(e){return e.replace(/^-*?(?:update|edit)-*?$/gim,"---")},s=function(e){return e.replace(/\b[ ]{2,}/gm," ").trim()},f=function(e){return e.replace(/\bhttp:\/\//gim,"https://")},h=function(e){return e.replace(/\s+([,.?!])/gm,"$1")},v=function(a){return __awaiter(void 0,void 0,void 0,function(){var r,t,n;return __generator(this,function(e){switch(e.label){case 0:return(n=__read((r=/^(\w+)\s+-\s+/i).exec(a)||[],2),n=n[1])?(t=n.toLowerCase(),[4,i(t)]):[2,a];case 1:return n=e.sent(),[2,n.find(function(e){return e.name===t})?a.replace(r,""):a]}})})},d=document.querySelector("[name=post-text]"))?(_=[n,l,c,a,u,o,h,t,s,f].reduce(function(e,r){return r(e)},d.value),d.value=_,p=new Event("input",{bubbles:!0,cancelable:!0}),d.dispatchEvent(p),(_=document.getElementById("title"))?[4,r([s,n,v],_.value)]:[2]):[2];case 1:return v=e.sent(),_.value=v,_.dispatchEvent(p),[2]}})});