// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     semi-automated editing with style
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/editors-den#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            editors-den
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/editors-den.git
// @supportURL      https://github.com/userscripters/editors-den/issues
// @version         0.1.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,o,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function a(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}i((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,(t=o?[2&t[0],o.value]:t)[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,i=n.call(e),o=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)o.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return o},__spreadArray=this&&this.__spreadArray||function(e,t){for(var n=0,r=t.length,a=e.length;n<r;n++,a++)e[a]=t[n];return e};!function(t,f){var n={main:"editors-den"},e={GM_setValue:{get length(){return GM_listValues().length},clear:function(){return GM_listValues().forEach(function(e){return GM_deleteValue(e)})},key:function(e){return GM_listValues()[e]},getItem:function(e){return GM_getValue(e)},setItem:function(e,t){return GM_setValue(e,t)},removeItem:function(e){return GM_deleteValue(e)}},GM:{get length(){return GM.listValues().then(function(e){return e.length})},clear:function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent().forEach(function(e){return GM.deleteValue(e)})]}})})},key:function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent()[t]]}})})},getItem:function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,GM.getValue(n)];case 1:return[2,void 0===(t=e.sent())?null:null==t?void 0:t.toString()]}})})},setItem:function(e,t){return GM.setValue(e,t)},removeItem:function(e){return GM.deleteValue(e)}}},e=__read(Object.entries(e).find(function(e){e=__read(e,1)[0];return void 0!==t[e]})||[],2)[1],p=(o.clear=function(){var e=this.storage,t=this.prefix;e.removeItem(t)},o.open=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=(n=this).storage,n=n.prefix,[4,t.getItem(n)];case 1:return[2,(n=e.sent())?JSON.parse(n):{}]}})})},o.has=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.open()];case 1:return t=e.sent(),[2,n in t]}})})},o.load=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.open()];case 1:return[2,void 0!==(t=e.sent()[n])?t:r]}})})},o.save=function(a,i){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=(r=this).storage,n=r.prefix,[4,o.open()];case 1:return(r=e.sent())[a]=i,[2,t.setItem(n,JSON.stringify(r))]}})})},o.toggle=function(a){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return n=(t=o).save,r=[a],[4,o.load(a)];case 1:return[2,n.apply(t,r.concat([!e.sent()]))]}})})},o.remove=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.prefix,[4,this.load(t,{})];case 1:return delete(t=e.sent())[n],[2,o.save(n,t)]}})})},o.storage=e||localStorage,o.prefix=n.main,o);function o(){}function r(e,t,n){var r=void 0===(s=(u=void 0===n?{}:n).buttons)?[]:s,a=void 0===(o=u.classes)?[]:o,i=u.msgClasses,n=void 0===i?[]:i,o=void 0===(s=u.type)?"none":s,s=void 0!==(i=u.important)&&i,u=document.createElement("div");return(i=u.classList).add.apply(i,__spreadArray(["s-toast"],__read(a))),u.setAttribute("aria-hidden","true"),u.setAttribute("role","alertdialog"),u.setAttribute("aria-labelledby","notice-message"),u.id=e,(a=document.createElement("aside")).classList.add("s-notice","p8","pl16"),"none"!==o&&a.classList.add("s-notice__"+o),s&&a.classList.add("s-notice__important"),e=document.createElement("div"),(o=e.classList).add.apply(o,__spreadArray(["d-flex","gs16","gsx","ai-center","jc-space-between"],__read(n))),(s=document.createElement("div")).classList.add("flex--item"),s.textContent=t,(o=document.createElement("div")).classList.add("d-flex"),(n=document.createElement("button")).type="button",n.classList.add("s-btn","s-notice--btn"),n.setAttribute("aria-label","Dismiss"),r.push(n),t=__read(function(e,t,n){var r=void 0===n?{}:n,a=r.classes,i=void 0===a?[]:a,o=r.width,s=void 0===o?14:o,n=r.height,a=void 0===n?s:n,o="http://www.w3.org/2000/svg",r=document.createElementNS(o,"svg");(n=r.classList).add.apply(n,__spreadArray(["svg-icon",e],__read(i))),r.setAttribute("width",s.toString()),r.setAttribute("height",a.toString()),r.setAttribute("viewBox","0 0 "+s+" "+a),r.setAttribute("aria-hidden","true");o=document.createElementNS(o,"path");return o.setAttribute("d",t),r.append(o),[r,o]}("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14}),1)[0],n.append(t),o.append.apply(o,__spreadArray([],__read(r))),e.append(s,o),a.append(e),u.append(a),u}function a(e,t){var n=f.querySelector("ol.user-logged-in, ol.user-logged-out");if(!n)return console.debug("failed to find main menu");(e=f.getElementById(e)||function(e){var t=f.createElement("li");t.classList.add("-item"),t.id=e,t.title="Apply auto-edits";var n=f.createElement("a");n.classList.add("-link");e=f.createElement("strong");return e.textContent="E&D",n.append(e),t.append(n),t}(e)).isConnected||(n.append(e),e.addEventListener("click",function(e){e.preventDefault(),t()}))}function v(e,t){return e.reduce(function(n,r){return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=r,[4,n];case 1:return[4,t.apply(void 0,[e.sent()])];case 2:return[2,e.sent()]}})})},Promise.resolve(t))}function h(e){var r=__spreadArray([],__read(e.matchAll(/\[\d+\]: \w+/gim))).length,t=__spreadArray([],__read(e.matchAll(/\[([\w\s:'#-?]+)\]\(([\w:/.#-]+)\)/gim)));return e+"\n\n"+t.reduce(function(e,t,n){t=__read(t,3),t[0],t[1],t=t[2];return e+"["+(r+n+1)+"]: "+t+"\n"},"")}function _(e){return e.replace(/\*{2}(\[.+?\]\(.+?\))\*{2}/gim,"$1")}function m(e){return e.replace(/([?!,.])(\s+\(.+?\))/gm,"$2$1")}function g(e){return e.replace(/^Hi\b/i,"")}function b(e){return e.replace(/(?:^\n$)+/gim,"")}function w(e){return e.replace(/^-*?(?:update|edit)-*?$/gim,"---")}function y(e){return e.replace(/\b[ ]{2,}/gm," ").trim()}function k(e){return e.replace(/\bhttp:\/\//gim,"https://")}function x(e){return e.replace(/\s+([,.?!])/gm,"$1")}function E(o){return __awaiter(void 0,void 0,void 0,function(){var t,a,i;return __generator(this,function(e){switch(e.label){case 0:return(i=__read((t=/^(\w+)(?:\s+-|:)\s+/i).exec(o)||[],2),i=i[1])?(a=i.toLowerCase(),[4,(n=a,void 0===r&&(r=2.3),__awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("https://api.stackexchange.com/"+r+"/tags")).search=new URLSearchParams({site:location.hostname,inname:n.toLowerCase(),key:"C0zI0cCMTw5GRQIqHhvTHw(("}).toString(),[4,fetch(t.toString())];case 1:return(t=e.sent()).ok?[4,t.json()]:[2,[]];case 2:return[2,e.sent().items]}})}))]):[2,o];case 1:return i=e.sent(),[2,i.find(function(e){return e.name===a})?o.replace(t,""):o]}var n,r})})}var i=function(e,t){var n="string"==typeof e?document.querySelector(e):e;if(!n)throw new ReferenceError("missing toast: "+e);e="true"!==n.getAttribute("aria-hidden");return n.setAttribute("aria-hidden",(void 0!==t?!t:e).toString()),n},S=function(e,t){var n=i(e,!0);t&&setTimeout(function(){var e,t;t=i(n,!1),e&&setTimeout(function(){return S(t)},1e3*e)},1e3*t)};[/chat\.(?:stackoverflow|(meta\.)?stackexchange)\.com/].reduce(function(e,t){return t.test(location.href)},!1)||t.addEventListener("load",function(){var e=n.main;!function(e,t){var n=e.createElement("style");e.head.append(n);e=n.sheet;e&&(e.insertRule("#"+t+" strong {\n            background-color: var(--black-400);\n            mask-image: url("+(n="https://upload.wikimedia.org/wikipedia/commons/c/c4/Quill_and_ink.svg")+");\n            mask-repeat: no-repeat;\n            mask-size: 18px 18px;\n            mask-origin: content-box;\n            mask-position: center;\n            -webkit-mask-image: url("+n+");\n            -webkit-mask-repeat: no-repeat;\n            -webkit-mask-size: 18px 18px;\n            -webkit-mask-origin: content-box;\n            -webkit-mask-position: center;\n            min-height: 18px;\n        }"),e.insertRule("#"+t+" .-link:hover strong {\n            background-color: var(--black-700);\n        }"))}(f,e);var l=r(e+"-no-editable","This is not the page you are looking for",{important:!0,type:"warning"}),d=r(e+"-edit-success","Successfully edited the post",{important:!0,type:"success"});f.body.append(l,d),a(e,function(){return __awaiter(void 0,void 0,void 0,function(){var n,r,a,i,o,s,u,c;return __generator(this,function(e){switch(e.label){case 0:return(n=f.querySelector("[name=post-text]"),r=f.getElementById("title"),n||r)?(a=["I","Gmail","Google","Firefox","JavaScript","TypeScript","HTML","jQuery","URL","SDK","Safari","Linux","Greasemonkey","API"],i="capitalizations",[4,p.has(i)]):[2,S(l,3)];case 1:return e.sent()?[3,3]:[4,p.save(i,a)];case 2:e.sent(),e.label=3;case 3:return[4,p.load(i,a)];case 4:return s=e.sent(),console.debug({capitalizations:s}),t=s,o=[u=function(e){return t.reduce(function(e,t){return e.replace(new RegExp("(\\s+|^)"+t+"(\\s+|$)","gmi"),"$1"+t+"$2")},e)},w,b,_,g,m,x,h,y,k],s=[y,E,u],u=new Event("input",{bubbles:!0,cancelable:!0}),n?[4,v(o,n.value)]:[3,6];case 5:c=e.sent(),n.value=c,n.dispatchEvent(u),e.label=6;case 6:return r?[4,v(s,r.value)]:[3,8];case 7:c=e.sent(),r.value=c,r.dispatchEvent(u),e.label=8;case 8:return S(d,3),[2]}var t})})})})}(window,document);