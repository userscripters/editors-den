// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     semi-automated editing with style
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/editors-den#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            editors-den
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/editors-den.git
// @supportURL      https://github.com/userscripters/editors-den/issues
// @version         0.2.1
// ==/UserScript==

"use strict";((t,g)=>{const a={ids:{main:"editors-den"}};var[,e]=Object.entries({GM_setValue:{get length(){return GM_listValues().length},clear(){const e=GM_listValues();return e.forEach(e=>GM_deleteValue(e))},key(e){return GM_listValues()[e]},getItem(e){return GM_getValue(e)},setItem(e,t){return GM_setValue(e,t)},removeItem(e){return GM_deleteValue(e)}},GM:{get length(){return GM.listValues().then(e=>e.length)},async clear(){const e=await GM.listValues();return e.forEach(e=>GM.deleteValue(e))},async key(e){return(await GM.listValues())[e]},async getItem(e){const t=await GM.getValue(e);return void 0===t?null:null===t||void 0===t?void 0:t.toString()},setItem(e,t){return GM.setValue(e,t)},removeItem(e){return GM.deleteValue(e)}}}).find(([e])=>void 0!==t[e])||[];class h{static clear(){const{storage:e,prefix:t}=this;e.removeItem(t)}static async open(){const{storage:e,prefix:t}=this;var a=await e.getItem(t);return a?JSON.parse(a):{}}static async has(e){return e in await h.open()}static async load(e,t){e=(await h.open())[e];return void 0!==e?e:t}static async save(e,t){const{storage:a,prefix:s}=this,n=await h.open();return n[e]=t,a.setItem(s,JSON.stringify(n))}static async toggle(e){return h.save(e,!await h.load(e))}static async remove(e){var t=this["prefix"];const a=await this.load(t,{});return delete a[e],h.save(e,a)}}h.storage=e||localStorage,h.prefix=a.ids.main;const s=(e,t,{buttons:a=[],classes:s=[],msgClasses:n=[],type:i="none",important:r=!1}={})=>{const o=document.createElement("div");o.classList.add("s-toast",...s),o.setAttribute("aria-hidden","true"),o.setAttribute("role","alertdialog"),o.setAttribute("aria-labelledby","notice-message"),o.id=e;const c=document.createElement("aside");c.classList.add("s-notice","p8","pl16"),"none"!==i&&c.classList.add(`s-notice__${i}`),r&&c.classList.add("s-notice__important");const l=document.createElement("div");l.classList.add("d-flex","gs16","gsx","ai-center","jc-space-between",...n);const d=document.createElement("div");d.classList.add("flex--item"),d.textContent=t;const u=document.createElement("div");u.classList.add("d-flex");const p=document.createElement("button");p.type="button",p.classList.add("s-btn","s-notice--btn"),p.setAttribute("aria-label","Dismiss"),a.push(p);var[t]=((e,t,{classes:a=[],width:s=14,height:n=s})=>{var i="http://www.w3.org/2000/svg";const r=document.createElementNS(i,"svg");r.classList.add("svg-icon",e,...a),r.setAttribute("width",s.toString()),r.setAttribute("height",n.toString()),r.setAttribute("viewBox",`0 0 ${s} ${n}`),r.setAttribute("aria-hidden","true");const o=document.createElementNS(i,"path");return o.setAttribute("d",t),r.append(o),[r,o]})("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14});return p.append(t),u.append(...a),l.append(d,u),c.append(l),o.append(c),o},n=(e,t)=>{const a="string"==typeof e?document.querySelector(e):e;if(!a)throw new ReferenceError(`missing toast: ${e}`);const s="true"!==a.getAttribute("aria-hidden");return a.setAttribute("aria-hidden",(void 0!==t?!t:s).toString()),a},w=(e,t)=>{const a=n(e,!0);t&&setTimeout(()=>((e,t)=>{const a=n(e,!1);t&&setTimeout(()=>w(a),1e3*t)})(a),1e3*t)},i=(e,t)=>{const a=g.querySelector("ol.user-logged-in, ol.user-logged-out");if(!a)return console.debug("failed to find main menu");const s=g.getElementById(e)||(e=>{const t=g.createElement("li");t.classList.add("-item"),t.id=e,t.title="Apply auto-edits";const a=g.createElement("a");a.classList.add("-link");const s=g.createElement("strong");return s.textContent="E&D",a.append(s),t.append(a),t})(e);s.isConnected||(a.append(s),s.addEventListener("click",e=>{e.preventDefault(),t()}))},v=async(e,t)=>{const s=[];return{result:await e.reduce(async(e,[t,a])=>{e=await e,t=await t(e);return t!==e&&a&&s.push(a),t},Promise.resolve(t)),messages:s}},o=async(e,t=2.3)=>{const a=new URL(`https://api.stackexchange.com/${t}/tags`);a.search=new URLSearchParams({site:location.hostname,inname:e.toLowerCase(),key:"C0zI0cCMTw5GRQIqHhvTHw(("}).toString();const s=await fetch(a.toString());if(!s.ok)return[];var n=(await s.json())["items"];return n.length?n:o(e.replace(/[-]/g,""),t)},b=e=>{const s=[...e.matchAll(/\[\d+\]: \w+/gim)]["length"],t=[...e.matchAll(/\[([\w\s:'#-?]+)\]\(([\w:/.#-]+)\)/gim)];return`${e}\n\n${t.reduce((e,[,,t],a)=>`${e}[${s+a+1}]: ${t}\n`,"")}`},f=e=>e.replace(/\*{2}(\[.+?\]\(.+?\))\*{2}/gim,"$1"),y=e=>e.replace(/([?!,.])(\s+\(.+?\))/gm,"$2$1"),k=e=>e.replace(/^Hi\b/i,""),$=e=>e.replace(/(?:^\n$)+/gim,""),E=e=>e.replace(/^-*?(?:update|edit)-*?$/gim,"---"),x=e=>e.replace(/\b[ ]{2,}/gm," ").trim(),S=e=>e.replace(/\bhttp:\/\//gim,"https://"),G=e=>e.replace(/\s+([,.?!])/gm,"$1"),L=async e=>{const t=/^([\w-]{1,35})(?:\s?[-:|])\s+/i,[,a]=t.exec(e)||[];if(!a)return e;const s=a.toLowerCase(),n=await o(s),i=n.find(({name:e})=>e===s);if(i)return i?e.replace(t,""):e;{const r=s.replace(/[-]/g,""),n=await o(r),i=n.find(({name:e})=>e===r);return i?e.replace(t,""):e}};[/chat\.(?:stackoverflow|(meta\.)?stackexchange)\.com/].reduce((e,t)=>t.test(location.href),!1)||t.addEventListener("load",()=>{var e=a.ids.main;((e,t)=>{var a=e.createElement("style");e.head.append(a);const s=a["sheet"];s&&(a="https://upload.wikimedia.org/wikipedia/commons/c/c4/Quill_and_ink.svg",s.insertRule(`#${t} strong {
            background-color: var(--black-400);
            mask-image: url(${a});
            mask-repeat: no-repeat;
            mask-size: 18px 18px;
            mask-origin: content-box;
            mask-position: center;
            -webkit-mask-image: url(${a});
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-size: 18px 18px;
            -webkit-mask-origin: content-box;
            -webkit-mask-position: center;
            min-height: 18px;
        }`),s.insertRule(`#${t} .-link:hover strong {
            background-color: var(--black-700);
        }`))})(g,e);const p=s(`${e}-no-editable`,"This is not the page you are looking for",{important:!0,type:"warning"}),m=s(`${e}-edit-success`,"Successfully edited the post",{important:!0,type:"success"});g.body.append(p,m),i(e,async()=>{const e=g.querySelector("[name=post-text]"),t=g.getElementById("title"),a=g.querySelector(".js-post-edit-comment-field");if(!e&&!t)return w(p,3);var s=["I","Gmail","Google","Firefox","JavaScript","TypeScript","HTML","jQuery","URL","SDK","Safari","Linux","Greasemonkey","API"],n="capitalizations";await h.has(n)||await h.save(n,s);var i,r=await h.load(n,s),n=(i=r,e=>i.reduce((e,t)=>e.replace(new RegExp(`(?:(\`{3,}[\\s\\S]*?|))(?<!(?:http|ws|ftp)s?:\\/\\/.*?)(\\b)${t}(\\b)(?![\\s\\S]*?\`{3,})`,"gmi"),`$1${t}$2`).replace(new RegExp(`(?<!\`{3,}[\\s\\S]*?|\\b(?:http|ws|ftp)s?:\\/\\/.*?)(\\b)${t}(\\b)(?:|[\\s\\S]*?\`{3,})`,"gmi"),`$1${t}$2`),e)),s=[[n,"properly capitalized"],[E,"removed noise"],[$],[f],[k],[y],[G],[b],[x],[S]],r=[[x],[L,"removed tag from title (see https://stackoverflow.com/help/tagging)"],[n,"properly capitalized"]],n=new Event("input",{bubbles:!0,cancelable:!0});const o=new Set;if(e){const{result:c,messages:l}=await v(s,e.value);l.forEach(e=>o.add(e)),e.value=c,e.dispatchEvent(n)}if(t){const{result:d,messages:u}=await v(r,t.value);u.forEach(e=>o.add(e)),t.value=d,t.dispatchEvent(n)}a&&(a.value=[...o].join("; "),a.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))),w(m,3)})})})(window,document);