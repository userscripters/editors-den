// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     semi-automated editing with style
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/editors-den#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            editors-den
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/editors-den.git
// @supportURL      https://github.com/userscripters/editors-den/issues
// @version         0.2.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,o,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function a(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}i((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,(t=o?[2&t[0],o.value]:t)[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,i=n.call(e),o=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)o.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return o},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,i=t.length;a<i;a++)!r&&a in t||((r=r||Array.prototype.slice.call(t,0,a))[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))};!function(t,h){var n={main:"editors-den"},e={GM_setValue:{get length(){return GM_listValues().length},clear:function(){return GM_listValues().forEach(function(e){return GM_deleteValue(e)})},key:function(e){return GM_listValues()[e]},getItem:function(e){return GM_getValue(e)},setItem:function(e,t){return GM_setValue(e,t)},removeItem:function(e){return GM_deleteValue(e)}},GM:{get length(){return GM.listValues().then(function(e){return e.length})},clear:function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent().forEach(function(e){return GM.deleteValue(e)})]}})})},key:function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent()[t]]}})})},getItem:function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,GM.getValue(n)];case 1:return[2,void 0===(t=e.sent())?null:null==t?void 0:t.toString()]}})})},setItem:function(e,t){return GM.setValue(e,t)},removeItem:function(e){return GM.deleteValue(e)}}},e=__read(Object.entries(e).find(function(e){e=__read(e,1)[0];return void 0!==t[e]})||[],2)[1],_=(o.clear=function(){var e=this.storage,t=this.prefix;e.removeItem(t)},o.open=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=(n=this).storage,n=n.prefix,[4,t.getItem(n)];case 1:return[2,(n=e.sent())?JSON.parse(n):{}]}})})},o.has=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.open()];case 1:return t=e.sent(),[2,n in t]}})})},o.load=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.open()];case 1:return[2,void 0!==(t=e.sent()[n])?t:r]}})})},o.save=function(a,i){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=(r=this).storage,n=r.prefix,[4,o.open()];case 1:return(r=e.sent())[a]=i,[2,t.setItem(n,JSON.stringify(r))]}})})},o.toggle=function(a){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return n=(t=o).save,r=[a],[4,o.load(a)];case 1:return[2,n.apply(t,r.concat([!e.sent()]))]}})})},o.remove=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.prefix,[4,this.load(t,{})];case 1:return delete(t=e.sent())[n],[2,o.save(n,t)]}})})},o.storage=e||localStorage,o.prefix=n.main,o);function o(){}function r(e,t,n){var r=void 0===(s=(u=void 0===n?{}:n).buttons)?[]:s,a=void 0===(o=u.classes)?[]:o,i=u.msgClasses,n=void 0===i?[]:i,o=void 0===(s=u.type)?"none":s,s=void 0!==(i=u.important)&&i,u=document.createElement("div");return(i=u.classList).add.apply(i,__spreadArray(["s-toast"],__read(a),!1)),u.setAttribute("aria-hidden","true"),u.setAttribute("role","alertdialog"),u.setAttribute("aria-labelledby","notice-message"),u.id=e,(a=document.createElement("aside")).classList.add("s-notice","p8","pl16"),"none"!==o&&a.classList.add("s-notice__"+o),s&&a.classList.add("s-notice__important"),e=document.createElement("div"),(o=e.classList).add.apply(o,__spreadArray(["d-flex","gs16","gsx","ai-center","jc-space-between"],__read(n),!1)),(s=document.createElement("div")).classList.add("flex--item"),s.textContent=t,(o=document.createElement("div")).classList.add("d-flex"),(n=document.createElement("button")).type="button",n.classList.add("s-btn","s-notice--btn"),n.setAttribute("aria-label","Dismiss"),r.push(n),t=__read(function(e,t,n){var r=void 0===n?{}:n,a=r.classes,i=void 0===a?[]:a,o=r.width,s=void 0===o?14:o,n=r.height,a=void 0===n?s:n,o="http://www.w3.org/2000/svg",r=document.createElementNS(o,"svg");(n=r.classList).add.apply(n,__spreadArray(["svg-icon",e],__read(i),!1)),r.setAttribute("width",s.toString()),r.setAttribute("height",a.toString()),r.setAttribute("viewBox","0 0 "+s+" "+a),r.setAttribute("aria-hidden","true");o=document.createElementNS(o,"path");return o.setAttribute("d",t),r.append(o),[r,o]}("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14}),1)[0],n.append(t),o.append.apply(o,__spreadArray([],__read(r),!1)),e.append(s,o),a.append(e),u.append(a),u}function a(e,t){var n=h.querySelector("ol.user-logged-in, ol.user-logged-out");if(!n)return console.debug("failed to find main menu");(e=h.getElementById(e)||function(e){var t=h.createElement("li");t.classList.add("-item"),t.id=e,t.title="Apply auto-edits";var n=h.createElement("a");n.classList.add("-link");e=h.createElement("strong");return e.textContent="E&D",n.append(e),t.append(n),t}(e)).isConnected||(n.append(e),e.addEventListener("click",function(e){e.preventDefault(),t()}))}function m(t,n){return __awaiter(void 0,void 0,void 0,function(){var o;return __generator(this,function(e){switch(e.label){case 0:return o=[],[4,t.reduce(function(r,e){var e=__read(e,2),a=e[0],i=e[1];return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,r];case 1:return t=e.sent(),[4,a(t)];case 2:return(n=e.sent())!==t&&i&&o.push(i),[2,n]}})})},Promise.resolve(n))];case 1:return[2,{result:e.sent(),messages:o}]}})})}function g(e){var r=__spreadArray([],__read(e.matchAll(/\[\d+\]: \w+/gim)),!1).length,t=__spreadArray([],__read(e.matchAll(/\[([\w\s:'#-?]+)\]\(([\w:/.#-]+)\)/gim)),!1);return e+"\n\n"+t.reduce(function(e,t,n){t=__read(t,3),t[0],t[1],t=t[2];return e+"["+(r+n+1)+"]: "+t+"\n"},"")}function b(e){return e.replace(/\*{2}(\[.+?\]\(.+?\))\*{2}/gim,"$1")}function w(e){return e.replace(/([?!,.])(\s+\(.+?\))/gm,"$2$1")}function y(e){return e.replace(/^Hi\b/i,"")}function k(e){return e.replace(/(?:^\n$)+/gim,"")}function x(e){return e.replace(/^-*?(?:update|edit)-*?$/gim,"---")}function S(e){return e.replace(/\b[ ]{2,}/gm," ").trim()}function E(e){return e.replace(/\bhttp:\/\//gim,"https://")}function A(e){return e.replace(/\s+([,.?!])/gm,"$1")}function G(s){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,a,i,o;return __generator(this,function(e){switch(e.label){case 0:return(n=__read((t=/^([\w-]{1,35})(?:\s?[-:|])\s+/i).exec(s)||[],2),n=n[1])?(r=n.toLowerCase(),[4,u(r)]):[2,s];case 1:return(o=e.sent(),a=o.find(function(e){return e.name===r}))?[3,3]:(i=r.replace(/[-]/g,""),[4,u(i)]);case 2:return o=e.sent(),[2,o.find(function(e){return e.name===i})?s.replace(t,""):s];case 3:return[2,a?s.replace(t,""):s]}})})}var i=function(e,t){var n="string"==typeof e?document.querySelector(e):e;if(!n)throw new ReferenceError("missing toast: "+e);e="true"!==n.getAttribute("aria-hidden");return n.setAttribute("aria-hidden",(void 0!==t?!t:e).toString()),n},L=function(e,t){var n=i(e,!0);t&&setTimeout(function(){var e,t;t=i(n,!1),e&&setTimeout(function(){return L(t)},1e3*e)},1e3*t)},u=function(r,a){return void 0===a&&(a=2.3),__awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("https://api.stackexchange.com/"+a+"/tags")).search=new URLSearchParams({site:location.hostname,inname:r.toLowerCase(),key:"C0zI0cCMTw5GRQIqHhvTHw(("}).toString(),[4,fetch(t.toString())];case 1:return(n=e.sent()).ok?[4,n.json()]:[2,[]];case 2:return(n=e.sent().items).length?[2,n]:[2,u(r.replace(/[-]/g,""),a)]}})})};[/chat\.(?:stackoverflow|(meta\.)?stackexchange)\.com/].reduce(function(e,t){return t.test(location.href)},!1)||t.addEventListener("load",function(){var e=n.main;!function(e,t){var n=e.createElement("style");e.head.append(n);e=n.sheet;e&&(e.insertRule("#"+t+" strong {\n            background-color: var(--black-400);\n            mask-image: url("+(n="https://upload.wikimedia.org/wikipedia/commons/c/c4/Quill_and_ink.svg")+");\n            mask-repeat: no-repeat;\n            mask-size: 18px 18px;\n            mask-origin: content-box;\n            mask-position: center;\n            -webkit-mask-image: url("+n+");\n            -webkit-mask-repeat: no-repeat;\n            -webkit-mask-size: 18px 18px;\n            -webkit-mask-origin: content-box;\n            -webkit-mask-position: center;\n            min-height: 18px;\n        }"),e.insertRule("#"+t+" .-link:hover strong {\n            background-color: var(--black-700);\n        }"))}(h,e);var p=r(e+"-no-editable","This is not the page you are looking for",{important:!0,type:"warning"}),v=r(e+"-edit-success","Successfully edited the post",{important:!0,type:"success"});h.body.append(p,v),a(e,function(){return __awaiter(void 0,void 0,void 0,function(){var n,r,a,i,o,s,u,c,l,d,f;return __generator(this,function(e){switch(e.label){case 0:return(n=h.querySelector("[name=post-text]"),r=h.getElementById("title"),a=h.querySelector(".js-post-edit-comment-field"),n||r)?(i=["I","Gmail","Google","Firefox","JavaScript","TypeScript","HTML","jQuery","URL","SDK","Safari","Linux","Greasemonkey","API"],o="capitalizations",[4,_.has(o)]):[2,L(p,3)];case 1:return e.sent()?[3,3]:[4,_.save(o,i)];case 2:e.sent(),e.label=3;case 3:return[4,_.load(o,i)];case 4:return u=e.sent(),t=u,s=[[c=function(e){return t.reduce(function(e,t){return e.replace(new RegExp("(?:(`{3,}[\\s\\S]*?|))(\\b)"+t+"(\\b)(?![\\s\\S]*?`{3,})","gmi"),"$1"+t+"$2").replace(new RegExp("(?<!`{3,}[\\s\\S]*?)(\\b)"+t+"(\\b)(?:|[\\s\\S]*?`{3,})","gmi"),"$1"+t+"$2")},e)},"properly capitalized"],[x,"removed noise"],[k],[b],[y],[w],[A],[g],[S],[E]],u=[[S],[G,"removed tag from title (see https://stackoverflow.com/help/tagging)"],[c,"properly capitalized"]],c=new Event("input",{bubbles:!0,cancelable:!0}),l=new Set,n?[4,m(s,n.value)]:[3,6];case 5:d=e.sent(),f=d.result,d.messages.forEach(function(e){return l.add(e)}),n.value=f,n.dispatchEvent(c),e.label=6;case 6:return r?[4,m(u,r.value)]:[3,8];case 7:d=e.sent(),f=d.result,d.messages.forEach(function(e){return l.add(e)}),r.value=f,r.dispatchEvent(c),e.label=8;case 8:return a&&(a.value=__spreadArray([],__read(l),!1).join("; "),a.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))),L(v,3),[2]}var t})})})})}(window,document);